-- NEXA â†’ CHILLI AUTO-PASTE (Waits for Chilli to load)
-- Compatible with Luarmor-protected Chilli Hub

local Players = game:GetService("Players")
local HttpService = game:GetService("HttpService")
local player = Players.LocalPlayer
local playerGui = player:WaitForChild("PlayerGui")

print("\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”")
print("ğŸ”— NEXA â†’ CHILLI BRIDGE")
print("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n")

-- Configuration
local SERVER_URL = "http://localhost:8080"
local UPDATE_INTERVAL = 3
local MAX_WAIT_TIME = 30  -- Wait up to 30 seconds for Chilli

-- Settings
local Settings = {
	AutoClickJoin = true,
	AutoPaste = true
}

-- Variables
local lastJobId = ""
local chilliGui = nil
local isReady = false

-- FUNCTION TO WAIT FOR CHILLI HUB TO LOAD
local function waitForChilli()
	print("â³ Waiting for Chilli Hub to load...")
	print("ğŸ’¡ This may take up to 30 seconds...\n")
	
	local startTime = tick()
	
	while tick() - startTime < MAX_WAIT_TIME do
		-- Search all GUIs
		for _, gui in pairs(playerGui:GetChildren()) do
			-- Look for "Server Tools", "Job-ID", or "Chilli" text
			for _, obj in pairs(gui:GetDescendants()) do
				if obj:IsA("TextLabel") or obj:IsA("TextButton") then
					local text = obj.Text or ""
					if text:find("Server Tools") or text:find("Job-ID Input") or 
					   text:find("Chilli") or text:find("Rejoin Server") then
						print("âœ… FOUND CHILLI HUB!")
						print("   GUI Name:", gui.Name)
						print("   Found via text:", text)
						print("")
						return gui
					end
				end
			end
		end
		
		task.wait(0.5)  -- Check every 0.5 seconds
	end
	
	print("âŒ Timed out waiting for Chilli Hub")
	print("ğŸ’¡ Make sure Chilli Hub loaded successfully\n")
	return nil
end

-- FUNCTION TO FIND JOB ID INPUT
local function findJobIdInput()
	if not chilliGui then return nil end
	
	-- Look for visible textboxes
	local textboxes = {}
	for _, obj in pairs(chilliGui:GetDescendants()) do
		if obj:IsA("TextBox") and obj.Visible then
			-- Check if parent is visible too
			local parent = obj.Parent
			if parent and parent.Visible then
				table.insert(textboxes, obj)
			end
		end
	end
	
	-- If only one visible textbox, that's probably it
	if #textboxes == 1 then
		print("âœ… Found Job ID input:", textboxes[1]:GetFullName())
		return textboxes[1]
	end
	
	-- If multiple, look for one with "Job" or "ID" in name or placeholder
	for _, box in pairs(textboxes) do
		local name = box.Name:lower()
		local placeholder = box.PlaceholderText and box.PlaceholderText:lower() or ""
		
		if name:find("job") or name:find("id") or 
		   placeholder:find("job") or placeholder:find("id") then
			print("âœ… Found Job ID input:", box:GetFullName())
			return box
		end
	end
	
	-- Last resort: return first visible textbox
	if #textboxes > 0 then
		print("âš ï¸ Using first visible textbox:", textboxes[1]:GetFullName())
		return textboxes[1]
	end
	
	return nil
end

-- FUNCTION TO FIND JOIN BUTTON
local function findJoinButton()
	if not chilliGui then return nil end
	
	for _, obj in pairs(chilliGui:GetDescendants()) do
		if (obj:IsA("TextButton") or obj:IsA("ImageButton")) and obj.Visible then
			local text = obj.Text or obj.Name or ""
			if text:lower():find("join") then
				return obj
			end
		end
	end
	
	return nil
end

-- FUNCTION TO PASTE INTO CHILLI
local function pasteToChilli(jobId, jobName)
	if not jobId or jobId == "" then return false end
	if not chilliGui then
		print("âŒ Chilli Hub not ready")
		return false
	end
	
	local input = findJobIdInput()
	
	if input then
		-- Paste the job ID
		input.Text = jobId
		print("âœ… Pasted to Chilli:", jobId)
		
		-- Visual feedback
		pcall(function()
			local originalColor = input.BackgroundColor3
			input.BackgroundColor3 = Color3.fromRGB(0, 255, 136)
			task.wait(0.3)
			input.BackgroundColor3 = originalColor
		end)
		
		-- Auto-click join if enabled
		if Settings.AutoClickJoin then
			task.wait(0.3)
			local button = findJoinButton()
			
			if button then
				print("ğŸ”˜ Clicking join button...")
				pcall(function()
					-- Try multiple methods
					for _, conn in pairs(getconnections(button.MouseButton1Click)) do
						conn:Fire()
					end
					button.MouseButton1Click:Fire()
					
					-- Simulate mouse click
					local vim = game:GetService("VirtualInputManager")
					local pos = button.AbsolutePosition
					local size = button.AbsoluteSize
					vim:SendMouseButtonEvent(pos.X + size.X/2, pos.Y + size.Y/2, 0, true, button, 0)
					vim:SendMouseButtonEvent(pos.X + size.X/2, pos.Y + size.Y/2, 0, false, button, 0)
				end)
				print("âœ… Clicked join button")
			else
				print("âš ï¸ Join button not found - paste only")
			end
		end
		
		return true
	else
		print("âŒ Job ID input not found")
		print("ğŸ’¡ Make sure you're on the Server Tools tab")
		return false
	end
end

-- MANUAL TEST COMMAND
_G.NexaTest = function(jobId)
	jobId = jobId or "test-job-12345"
	
	print("\nğŸ§ª TESTING PASTE TO CHILLI...")
	print("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”")
	
	if not chilliGui then
		print("âŒ Chilli Hub not loaded yet")
		print("ğŸ’¡ Wait for it to finish loading, then try again")
		return
	end
	
	print("âœ… Chilli GUI:", chilliGui.Name)
	
	local input = findJobIdInput()
	if not input then
		print("âŒ Could not find Job ID input")
		print("ğŸ’¡ Make sure Chilli is on Server Tools tab")
		return
	end
	
	print("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”")
	print("ğŸ“¤ Pasting test job ID:", jobId)
	
	local success = pasteToChilli(jobId, "Test Job")
	
	if success then
		print("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”")
		print("âœ… TEST SUCCESSFUL!")
		print("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n")
	else
		print("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”")
		print("âŒ TEST FAILED")
		print("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n")
	end
end

-- FETCH JOBS FROM SERVER
local function fetchJobs()
	local success, result = pcall(function()
		return game:HttpGet(SERVER_URL .. "/jobs", true)
	end)
	
	if success and result then
		local decodeSuccess, data = pcall(function()
			return HttpService:JSONDecode(result)
		end)
		
		if decodeSuccess and data and data.jobs and #data.jobs > 0 then
			local latestJob = data.jobs[1]
			
			if latestJob and latestJob.jobId and latestJob.jobId ~= lastJobId then
				lastJobId = latestJob.jobId
				
				print("")
				print("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”")
				print("ğŸ”¥ NEW JOB:", latestJob.name)
				print("ğŸ’°", latestJob.money, "| ğŸ‘¥", latestJob.players)
				print("ğŸ”‘", latestJob.jobId)
				print("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”")
				
				if Settings.AutoPaste and chilliGui then
					task.wait(0.5)
					local success = pasteToChilli(latestJob.jobId, latestJob.name)
					if success then
						print("âœ… Sent to Chilli!")
					end
					print("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n")
				end
			end
		end
	end
end

-- MAIN EXECUTION
task.spawn(function()
	-- Wait for Chilli to load
	chilliGui = waitForChilli()
	
	if chilliGui then
		isReady = true
		
		print("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”")
		print("âœ… NEXA â†’ CHILLI BRIDGE READY!")
		print("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”")
		print("ğŸ“‹ TEST COMMAND:")
		print("   _G.NexaTest() or _G.NexaTest('job-id')")
		print("")
		print("âš™ï¸ Auto-Paste:", Settings.AutoPaste and "ON âœ…" or "OFF âŒ")
		print("âš™ï¸ Auto-Click:", Settings.AutoClickJoin and "ON âœ…" or "OFF âŒ")
		print("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”")
		print("ğŸ”„ Connecting to desktop server...")
		print("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n")
		
		-- Start monitoring for jobs
		while true do
			fetchJobs()
			task.wait(UPDATE_INTERVAL)
		end
	else
		print("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”")
		print("âŒ FAILED TO FIND CHILLI HUB")
		print("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”")
		print("ğŸ’¡ MAKE SURE:")
		print("   1. Chilli Hub script loaded successfully")
		print("   2. Wait 5-10 seconds after loading Chilli")
		print("   3. Open Server Tools tab")
		print("   4. Then run this script")
		print("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n")
	end
end)

