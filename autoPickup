local player = game.Players.LocalPlayer
local playerGui = player:WaitForChild("PlayerGui")

-- Create ScreenGui
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "NexaAutoPickupGui"
screenGui.ResetOnSpawn = false
screenGui.Parent = playerGui

-- Create Main Frame
local frame = Instance.new("Frame")
frame.Size = UDim2.new(0, 250, 0, 80)
frame.Position = UDim2.new(0.5, -125, 0, 30)
frame.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
frame.BorderSizePixel = 0
frame.Active = true
frame.Draggable = true
frame.Parent = screenGui

local frameCorner = Instance.new("UICorner")
frameCorner.CornerRadius = UDim.new(0, 12)
frameCorner.Parent = frame

-- Create Rainbow Outline
local outline = Instance.new("UIStroke")
outline.Thickness = 3
outline.Parent = frame

-- Rainbow animation for outline
local hue = 0
game:GetService("RunService").Heartbeat:Connect(function()
    hue = hue + 0.005
    if hue >= 1 then hue = 0 end
    outline.Color = Color3.fromHSV(hue, 1, 1)
end)

-- Create Toggle Button
local button = Instance.new("TextButton")
button.Size = UDim2.new(0, 220, 0, 50)
button.Position = UDim2.new(0.5, -110, 0.5, -25)
button.BackgroundColor3 = Color3.fromRGB(15, 15, 15)
button.Text = "NEXA AUTO PICK UP: OFF"
button.TextColor3 = Color3.fromRGB(0, 100, 0)
button.Font = Enum.Font.GothamBold
button.TextSize = 14
button.BorderSizePixel = 0
button.Parent = frame

local buttonCorner = Instance.new("UICorner")
buttonCorner.CornerRadius = UDim.new(0, 8)
buttonCorner.Parent = button

-- Button stroke
local buttonStroke = Instance.new("UIStroke")
buttonStroke.Thickness = 2
buttonStroke.Color = Color3.fromRGB(0, 80, 0)
buttonStroke.Parent = button

-- State variable
local instaPickupEnabled = false

-- Toggle function
button.MouseButton1Click:Connect(function()
    instaPickupEnabled = not instaPickupEnabled
   
    if instaPickupEnabled then
        button.TextColor3 = Color3.fromRGB(0, 255, 0)
        button.Text = "NEXA AUTO PICK UP: ON"
        buttonStroke.Color = Color3.fromRGB(0, 255, 0)
    else
        button.TextColor3 = Color3.fromRGB(0, 100, 0)
        button.Text = "NEXA AUTO PICK UP: OFF"
        buttonStroke.Color = Color3.fromRGB(0, 80, 0)
    end
end)

-- Improved pickup logic
local pickedUpItems = {}
local checkInterval = 0.1

task.spawn(function()
    while task.wait(checkInterval) do
        if not instaPickupEnabled then continue end
       
        local character = player.Character
        if not character then continue end
       
        local rootPart = character:FindFirstChild("HumanoidRootPart")
        if not rootPart then continue end
       
        -- Search for ProximityPrompts in workspace
        for _, descendant in pairs(workspace:GetDescendants()) do
            if descendant:IsA("ProximityPrompt") and descendant.Enabled then
                local promptParent = descendant.Parent
                
                if promptParent and promptParent:IsA("BasePart") then
                    -- Calculate distance
                    local distance = (promptParent.Position - rootPart.Position).Magnitude
                   
                    -- Check if within range and not already picked up
                    if distance <= descendant.MaxActivationDistance then
                        local itemId = promptParent:GetFullName()
                        
                        if not pickedUpItems[itemId] then
                            -- Mark as picked up to avoid spam
                            pickedUpItems[itemId] = true
                            
                            -- Trigger the proximity prompt
                            task.spawn(function()
                                pcall(function()
                                    fireproximityprompt(descendant)
                                end)
                            end)
                            
                            -- Clear from picked up list after delay
                            task.delay(2, function()
                                pickedUpItems[itemId] = nil
                            end)
                            
                            -- Small delay to prevent overwhelming the server
                            task.wait(0.05)
                        end
                    end
                end
            end
        end
    end
end)

-- Cleanup picked up items table periodically
task.spawn(function()
    while task.wait(10) do
        -- Clear old entries
        for id, _ in pairs(pickedUpItems) do
            local success = pcall(function()
                local parts = string.split(id, ".")
                local obj = workspace
                for _, part in ipairs(parts) do
                    obj = obj:FindFirstChild(part)
                    if not obj then break end
                end
                -- If object doesn't exist anymore, remove from table
                if not obj then
                    pickedUpItems[id] = nil
                end
            end)
        end
    end
end)
