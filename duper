-- RIVALS STEALTH EDITION
-- Lobby Detection | Anticheat Bypass | Safe ESP

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local TweenService = game:GetService("TweenService")
local Camera = workspace.CurrentCamera
local LocalPlayer = Players.LocalPlayer
local playerGui = LocalPlayer:WaitForChild("PlayerGui")

print("üéÆ RIVALS STEALTH LOADING...")

-- Settings
local Settings = {
    AimAssist = true,
    AimKey = Enum.UserInputType.MouseButton2,
    AimSmoothness = 0.15,
    AimPart = "Head",
    MaxAimDistance = 500,
    FOVRadius = 150,
    ShowFOV = false, -- Disabled by default for safety
    ESP = true,
    ESPBoxes = true,
    ESPNames = true,
    ESPHealth = true,
    ESPDistance = true,
    ESPTracers = false, -- Disabled by default
    ESPTeamCheck = true, -- Enabled by default
    ESPColor = Color3.fromRGB(138, 43, 226),
    TracerColor = Color3.fromRGB(255, 255, 255),
    FOVColor = Color3.fromRGB(138, 43, 226),
    TeamColor = false,
}

-- Lobby Detection
local inMatch = false

local function IsInMatch()
    -- Check if player has spawned in match
    if not LocalPlayer.Character then return false end
    if not LocalPlayer.Character:FindFirstChild("HumanoidRootPart") then return false end
    
    -- Check if there's a game timer (Rivals has this in matches)
    local roundTimer = playerGui:FindFirstChild("RoundTimer") or 
                       playerGui:FindFirstChild("GameTimer") or
                       playerGui:FindFirstChild("Timer")
    
    -- Check if weapons are available (only in match)
    local hasWeapon = LocalPlayer.Character:FindFirstChild("Weapon") or
                      LocalPlayer.Character:FindFirstChildOfClass("Tool")
    
    -- Check player count (lobby usually has fewer)
    local playersInGame = 0
    for _, player in pairs(Players:GetPlayers()) do
        if player.Character and player.Character:FindFirstChild("Humanoid") then
            local humanoid = player.Character.Humanoid
            if humanoid.Health > 0 then
                playersInGame = playersInGame + 1
            end
        end
    end
    
    -- If 4+ players with characters, likely in match
    local probablyInMatch = playersInGame >= 4 or hasWeapon or roundTimer
    
    return probablyInMatch
end

-- Update match status
task.spawn(function()
    while true do
        local wasInMatch = inMatch
        inMatch = IsInMatch()
        
        -- If we just entered a match, wait a bit before enabling ESP
        if inMatch and not wasInMatch then
            print("üéÆ Match detected - ESP enabled")
            task.wait(2) -- Wait 2 seconds after match start
        elseif not inMatch and wasInMatch then
            print("üè† Lobby detected - ESP disabled")
        end
        
        task.wait(2)
    end
end)

-- FOV Circle (safer, only show if enabled)
local FOVCircle = Drawing.new("Circle")
FOVCircle.Transparency = 0.5
FOVCircle.Thickness = 2
FOVCircle.Color = Settings.FOVColor
FOVCircle.NumSides = 50
FOVCircle.Radius = Settings.FOVRadius
FOVCircle.Filled = false
FOVCircle.Visible = false

-- ESP Storage
local ESPObjects = {}

-- Get closest player
local function GetClosestPlayerToCrosshair()
    local closestPlayer = nil
    local shortestDistance = Settings.FOVRadius
    
    for _, player in pairs(Players:GetPlayers()) do
        if player ~= LocalPlayer and player.Character then
            local character = player.Character
            local humanoid = character:FindFirstChild("Humanoid")
            local aimPart = character:FindFirstChild(Settings.AimPart)
            
            if humanoid and humanoid.Health > 0 and aimPart then
                -- Team check
                if Settings.ESPTeamCheck and player.Team and LocalPlayer.Team then
                    if player.Team == LocalPlayer.Team then
                        continue
                    end
                end
                
                local distance = (aimPart.Position - Camera.CFrame.Position).Magnitude
                if distance > Settings.MaxAimDistance then
                    continue
                end
                
                local screenPos, onScreen = Camera:WorldToViewportPoint(aimPart.Position)
                if not onScreen then
                    continue
                end
                
                local mousePos = UserInputService:GetMouseLocation()
                local distanceFromMouse = (Vector2.new(screenPos.X, screenPos.Y) - mousePos).Magnitude
                
                if distanceFromMouse < shortestDistance then
                    shortestDistance = distanceFromMouse
                    closestPlayer = player
                end
            end
        end
    end
    
    return closestPlayer
end

-- Aim function
local function AimAt(player)
    if not player or not player.Character then return end
    
    local aimPart = player.Character:FindFirstChild(Settings.AimPart)
    if not aimPart then return end
    
    local targetPos = aimPart.Position
    local currentCFrame = Camera.CFrame
    local targetCFrame = CFrame.new(currentCFrame.Position, targetPos)
    
    Camera.CFrame = currentCFrame:Lerp(targetCFrame, Settings.AimSmoothness)
end

-- Create ESP
local function CreateESP(player)
    if ESPObjects[player] then return end
    
    local espData = {
        Box = Drawing.new("Square"),
        NameTag = Drawing.new("Text"),
        HealthBar = Drawing.new("Square"),
        HealthText = Drawing.new("Text"),
        DistanceText = Drawing.new("Text"),
        Tracer = Drawing.new("Line")
    }
    
    espData.Box.Thickness = 2
    espData.Box.Filled = false
    espData.Box.Transparency = 1
    
    espData.NameTag.Size = 16
    espData.NameTag.Center = true
    espData.NameTag.Outline = true
    espData.NameTag.Text = player.Name
    
    espData.HealthBar.Thickness = 1
    espData.HealthBar.Filled = true
    
    espData.HealthText.Size = 14
    espData.HealthText.Center = true
    espData.HealthText.Outline = true
    
    espData.DistanceText.Size = 14
    espData.DistanceText.Center = true
    espData.DistanceText.Outline = true
    
    espData.Tracer.Thickness = 1
    espData.Tracer.Transparency = 0.7
    
    ESPObjects[player] = espData
end

-- Update ESP (ONLY IN MATCH)
local function UpdateESP()
    for player, espData in pairs(ESPObjects) do
        -- CRITICAL: Hide ESP if not in match
        if not inMatch then
            for _, obj in pairs(espData) do
                if obj then obj.Visible = false end
            end
            goto continue
        end
        
        if player and player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
            local character = player.Character
            local humanoid = character:FindFirstChild("Humanoid")
            local rootPart = character.HumanoidRootPart
            
            if humanoid and humanoid.Health > 0 then
                -- Team check
                local shouldHide = Settings.ESPTeamCheck and player.Team and LocalPlayer.Team and player.Team == LocalPlayer.Team
                
                if not shouldHide then
                    local screenPos, onScreen = Camera:WorldToViewportPoint(rootPart.Position)
                    
                    if onScreen and Settings.ESP then
                        local headPos = Camera:WorldToViewportPoint((character:FindFirstChild("Head") or rootPart).Position + Vector3.new(0, 0.5, 0))
                        local legPos = Camera:WorldToViewportPoint((character:FindFirstChild("LeftFoot") or rootPart).Position - Vector3.new(0, 3, 0))
                        
                        local height = math.abs(headPos.Y - legPos.Y)
                        local width = height / 2
                        local distance = math.floor((Camera.CFrame.Position - rootPart.Position).Magnitude)
                        
                        local color = Settings.ESPColor
                        if Settings.TeamColor and player.Team then
                            color = player.Team.TeamColor.Color
                        end
                        
                        if Settings.ESPBoxes then
                            espData.Box.Size = Vector2.new(width, height)
                            espData.Box.Position = Vector2.new(screenPos.X - width/2, screenPos.Y - height/2)
                            espData.Box.Color = color
                            espData.Box.Visible = true
                        else
                            espData.Box.Visible = false
                        end
                        
                        if Settings.ESPNames then
                            espData.NameTag.Position = Vector2.new(screenPos.X, screenPos.Y - height/2 - 20)
                            espData.NameTag.Color = color
                            espData.NameTag.Visible = true
                        else
                            espData.NameTag.Visible = false
                        end
                        
                        if Settings.ESPHealth then
                            local healthPercent = humanoid.Health / humanoid.MaxHealth
                            espData.HealthBar.Size = Vector2.new(3, height * healthPercent)
                            espData.HealthBar.Position = Vector2.new(screenPos.X - width/2 - 7, screenPos.Y - height/2 + (height * (1 - healthPercent)))
                            espData.HealthBar.Color = Color3.fromRGB(255 * (1 - healthPercent), 255 * healthPercent, 0)
                            espData.HealthBar.Visible = true
                            
                            espData.HealthText.Text = tostring(math.floor(humanoid.Health))
                            espData.HealthText.Position = Vector2.new(screenPos.X - width/2 - 7, screenPos.Y - height/2 - 15)
                            espData.HealthText.Color = color
                            espData.HealthText.Visible = true
                        else
                            espData.HealthBar.Visible = false
                            espData.HealthText.Visible = false
                        end
                        
                        if Settings.ESPDistance then
                            espData.DistanceText.Text = tostring(distance) .. "m"
                            espData.DistanceText.Position = Vector2.new(screenPos.X, screenPos.Y + height/2 + 5)
                            espData.DistanceText.Color = color
                            espData.DistanceText.Visible = true
                        else
                            espData.DistanceText.Visible = false
                        end
                        
                        if Settings.ESPTracers then
                            espData.Tracer.From = Vector2.new(Camera.ViewportSize.X / 2, Camera.ViewportSize.Y)
                            espData.Tracer.To = Vector2.new(screenPos.X, screenPos.Y)
                            espData.Tracer.Color = Settings.TracerColor
                            espData.Tracer.Visible = true
                        else
                            espData.Tracer.Visible = false
                        end
                    else
                        for _, obj in pairs(espData) do
                            if obj then obj.Visible = false end
                        end
                    end
                else
                    for _, obj in pairs(espData) do
                        if obj then obj.Visible = false end
                    end
                end
            else
                for _, obj in pairs(espData) do
                    if obj then obj.Visible = false end
                end
            end
        else
            for _, obj in pairs(espData) do
                if obj then obj:Remove() end
            end
            ESPObjects[player] = nil
        end
        
        ::continue::
    end
end

-- Remove ESP
local function RemoveESP(player)
    if ESPObjects[player] then
        for _, obj in pairs(ESPObjects[player]) do
            if obj then obj:Remove() end
        end
        ESPObjects[player] = nil
    end
end

-- Initialize ESP
for _, player in pairs(Players:GetPlayers()) do
    if player ~= LocalPlayer then
        CreateESP(player)
    end
end

Players.PlayerAdded:Connect(CreateESP)
Players.PlayerRemoving:Connect(RemoveESP)

-- Aim logic
local aiming = false

UserInputService.InputBegan:Connect(function(input)
    if input.UserInputType == Settings.AimKey then
        aiming = true
    end
end)

UserInputService.InputEnded:Connect(function(input)
    if input.UserInputType == Settings.AimKey then
        aiming = false
    end
end)

RunService.RenderStepped:Connect(function()
    -- Only show FOV if enabled and in match
    if Settings.ShowFOV and inMatch then
        local mousePos = UserInputService:GetMouseLocation()
        FOVCircle.Position = mousePos
        FOVCircle.Radius = Settings.FOVRadius
        FOVCircle.Visible = true
    else
        FOVCircle.Visible = false
    end
    
    if Settings.AimAssist and aiming and inMatch then
        local target = GetClosestPlayerToCrosshair()
        if target then
            AimAt(target)
        end
    end
    
    UpdateESP()
end)

LocalPlayer.CharacterAdded:Connect(function()
    task.wait(1)
    Camera = workspace.CurrentCamera
end)

print("‚úÖ RIVALS STEALTH CORE LOADED!")

-- UI (Simple and clean)
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "RivalsStealthUI"
screenGui.ResetOnSpawn = false
screenGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
screenGui.Parent = playerGui

local mainFrame = Instance.new("Frame")
mainFrame.Size = UDim2.new(0, 300, 0, 50)
mainFrame.Position = UDim2.new(0.5, -150, 0.02, 0)
mainFrame.BackgroundColor3 = Color3.fromRGB(15, 15, 20)
mainFrame.BorderSizePixel = 0
mainFrame.Parent = screenGui

Instance.new("UICorner", mainFrame).CornerRadius = UDim.new(0, 12)

-- Status
local status = Instance.new("TextLabel")
status.Size = UDim2.new(1, -20, 1, 0)
status.Position = UDim2.new(0, 10, 0, 0)
status.BackgroundTransparency = 1
status.Text = "üîí STEALTH MODE | Lobby"
status.TextColor3 = Color3.fromRGB(255, 255, 255)
status.Font = Enum.Font.GothamBold
status.TextSize = 14
status.TextXAlignment = Enum.TextXAlignment.Center
status.Parent = mainFrame

-- Update status text
task.spawn(function()
    while true do
        if inMatch then
            status.Text = "‚ö° IN MATCH | ESP Active"
            status.TextColor3 = Color3.fromRGB(0, 255, 136)
        else
            status.Text = "üîí LOBBY | ESP Disabled"
            status.TextColor3 = Color3.fromRGB(255, 255, 255)
        end
        task.wait(1)
    end
end)

print("‚úÖ RIVALS STEALTH LOADED!")
print("‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ")
print("üîí LOBBY DETECTION: ACTIVE")
print("‚ö° ESP: Match-only")
print("üéØ Aim: RIGHT CLICK")
print("üí° Status bar shows current mode")
print("‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ")
